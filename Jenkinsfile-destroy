pipeline {
    agent any

    stages {
        stage('Terraform plan') {
            steps {
                script {
                    withCredentials([
                        string(credentialsId: 'yc_token', variable: 'yc_token'),
                        string(credentialsId: 'cloud_id', variable: 'cloud_id'),
                        string(credentialsId: 'folder_id', variable: 'folder_id'),
                        string(credentialsId: 'ssh_key_pub', variable: 'ssh_key_pub')
                        ]) {
                            sh 'terraform init -input=false'
                        }
                }
            }
        }

        stage('Destroy yc infra') {
            steps {
                script {
                    withCredentials([
                        string(credentialsId: 'yc_token', variable: 'yc_token'),
                        string(credentialsId: 'cloud_id', variable: 'cloud_id'),
                        string(credentialsId: 'folder_id', variable: 'folder_id'),
                        string(credentialsId: 'ssh_key_pub', variable: 'ssh_key_pub')
                        ]) {
                            sh 'terraform apply -destroy -auto-approve -input=false'
                        }
                }
            }
        }
    }
}
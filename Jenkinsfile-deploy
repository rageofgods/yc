pipeline {
    agent any

    stages {
        stage('Terraform plan') {
            steps {
                script {
                    withCredentials([
                        string(credentialsId: 'yc_token', variable: 'yc_token'),
                        string(credentialsId: 'cloud_id', variable: 'cloud_id'),
                        string(credentialsId: 'folder_id', variable: 'folder_id'),
                        string(credentialsId: 'ssh_key_pub', variable: 'ssh_key_pub'),
                        string(credentialsId: 's3_access_key', variable: 's3_access_key'),
                        string(credentialsId: 's3_secret_key', variable: 's3_secret_key')
                        ]) {
                            sh 'terraform init -no-color -input=false -var "s3_access_key=${s3_access_key}" \
                                                            -var "s3_secret_key=${s3_secret_key}"'
                            sh 'terraform plan -no-color -input=false -out=tfplan -var "yc_token=${yc_token}" \
                                                                        -var "yc_cloud_id=${cloud_id}" \
                                                                        -var "yc_folder_id=${folder_id}" \
                                                                        -var "ssh_key=${ssh_key_pub}"'
                        }
                }
            }
        }

        stage('Deploy yc infra') {
            steps {
                script {
                    withCredentials([
                        string(credentialsId: 'yc_token', variable: 'yc_token'),
                        string(credentialsId: 'cloud_id', variable: 'cloud_id'),
                        string(credentialsId: 'folder_id', variable: 'folder_id'),
                        string(credentialsId: 'ssh_key_pub', variable: 'ssh_key_pub')
                        ]) {
                            sh 'terraform apply -no-color -input=false tfplan'
                        }
                }
            }
        }
    }
}